# Code Structure Guide

This guide describes the code structure, organization patterns, and style conventions used in the cs24-1-bot project.

## Table of Contents

- [Project Structure](#project-structure)
- [Code Style and Formatting](#code-style-and-formatting)
- [Naming Conventions](#naming-conventions)
- [Module Organization](#module-organization)
- [Discord Bot Patterns](#discord-bot-patterns)
- [Database Patterns](#database-patterns)
- [Common Patterns](#common-patterns)

## Project Structure

The project follows a clear directory structure:

```
.
├── src/              # Source code
│   ├── cogs/        # Discord command modules (Cogs)
│   ├── models/      # Data models
│   │   ├── ai/     # AI-related models
│   │   ├── database/ # Database models (Tortoise ORM)
│   │   └── mensa/  # Mensa-related models
│   ├── utils/       # Utility functions
│   │   ├── ai/     # AI utilities
│   │   └── memeUtils/ # Meme processing utilities
│   ├── migrations/  # Database migrations (aerich)
│   └── main.py      # Bot entry point
├── tests/           # Test files
├── docker/          # Docker configuration
├── data/            # Runtime data (gitignored)
├── docs/            # Documentation
└── pyproject.toml   # Project configuration
```

### Directory Purposes

- **`cogs/`**: Contains Discord.py Cogs (command modules). Each service (AI, Meme, Mensa, Quote) has its own Cog file.
- **`models/`**: Data models organized by domain (AI, database, mensa).
- **`utils/`**: Utility functions and helpers, organized by feature area.
- **`src/migrations/`**: Database migration files generated by aerich.
- **`data/`**: Runtime data like the SQLite database (gitignored).
- **`tests/`**: Test files organized to mirror the main codebase structure.

## Code Style and Formatting

### Python Style Guidelines

The project follows **PEP 8** conventions with specific configurations for consistency.

#### Line Length

- **Maximum 80 characters** per line
- Use line continuation for long statements

#### Indentation

- **4 spaces** (no tabs)
- Consistent indentation for all code blocks

#### YAPF Configuration

The project uses YAPF with these settings (from `pyproject.toml`).

### Imports

Organize imports in three groups:

1. Standard library imports
2. Third-party imports
3. Local imports

Example:

```python
import logging
import os
from typing import TYPE_CHECKING

import discord
from discord.ext import commands
from tortoise import fields

from models.database.baseModel import BaseModel
from utils.constants import Constants
```

Use `isort` to automatically organize imports correctly.

### Variable Declarations with Type Annotations

When a variable declaration with type annotation is too long (exceeds 80 characters), split it into two lines:

```python
# Instead of:
very_long_variable_name: dict[str, list[tuple[int, str]]] = {"key": [(1, "value")]}

# Do this:
very_long_variable_name: dict[str, list[tuple[int, str]]]
very_long_variable_name = {"key": [(1, "value")]}
```

This improves readability and keeps lines under the 80-character limit.

### Type Hints

- Add type hints to all function signatures
- Use explicit return types for public methods
- Use `TYPE_CHECKING` guard for imports that cause circular dependencies

Example:

```python
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from discord import Bot

def initialize(bot: "Bot") -> None:
    """Initialize the service."""
    pass
```

### Docstrings

Use docstrings for:
- All classes
- Non-trivial functions and methods

Use triple quotes for docstrings:

```python
def calculate_total(items: list[int]) -> int:
    """
    Calculate the total sum of all items.
    
    Args:
        items: List of integers to sum.
        
    Returns:
        The total sum of all items.
    """
    return sum(items)
```

## Naming Conventions

### Classes

Use **PascalCase** for class names:

```python
class AIService(commands.Cog):
    pass

class MemeService(commands.Cog):
    pass

class User(BaseModel):
    pass
```

### Functions and Methods

Use **snake_case** for function and method names:

```python
def reset_ai_usage() -> None:
    pass

def save_meme_image(image_url: str) -> None:
    pass

async def get_user_data(user_id: int) -> User:
    pass
```

### Constants

Use **UPPER_CASE** with underscores for constants:

```python
MAX_TRANSLATE_REQUESTS_PER_DAY = 10
DEFAULT_TIMEOUT = 30
API_BASE_URL = "https://api.example.com"
```

### Private Methods

Prefix private methods and attributes with a single underscore:

```python
class Service:
    def _helper_method(self) -> None:
        """Private helper method."""
        pass
    
    def public_method(self) -> None:
        """Public method that uses the helper."""
        self._helper_method()
```

## Module Organization

### Cogs (Discord Commands)

Group related functionality into Cogs following the Discord.py pattern:

```python
class ServiceName(commands.Cog):
    """
    Brief description of the Cog's purpose.
    
    This Cog handles [specific functionality].
    """

    def __init__(self, bot: discord.Bot, logger: logging.Logger) -> None:
        self.logger = logger
        self.bot = bot
        # Initialize any resources
```

### Data Models

Place data models in `models/database/` and inherit from `BaseModel`:

```python
from models.database.baseModel import BaseModel
from tortoise import fields

class ModelName(BaseModel):
    """Description of what this model represents."""
    
    id = fields.IntField(pk=True, description="Primary key")
    field_name = fields.CharField(
        max_length=255,
        description="Field description"
    )
```

### Utility Functions

Place utility functions in appropriate `utils/` subdirectories:

- `utils/ai/`: AI-related utilities
- `utils/memeUtils/`: Meme processing utilities
- `utils/`: General utilities (constants, type aliases, etc.)

### Constants

Centralize all constants in `utils/constants.py` using this pattern:

```python
class CategoryName:
    CONSTANT_NAME = value
    ANOTHER_CONSTANT = value

class Constants:
    CATEGORY = CategoryName
```

Access constants as: `Constants.CATEGORY.CONSTANT_NAME`

## Discord Bot Patterns

### Slash Commands

Use slash commands with guild restriction:

```python
@commands.slash_command(
    name="command_name",
    description="German description of what the command does",
    guild_ids=[Constants.SERVER_IDS.CUR_SERVER]
)
@discord.option(
    "parameter_name",
    type=discord.SlashCommandOptionType.string,
    required=True
)
async def command_name(
    self,
    ctx: ApplicationContext,
    parameter_name: str
) -> None:
    """Implementation of the command."""
    # Command logic here
    await ctx.respond("Response message")
```

### Event Listeners

Implement event listeners in Cogs:

```python
@commands.Cog.listener()
async def on_ready(self) -> None:
    """
    Runs when the bot is ready.
    """
    # Initialization logic
    self.logger.info("Service started successfully")

@commands.Cog.listener("on_message")
async def handler_name(self, message: discord.Message) -> None:
    """
    Handles incoming messages.
    
    Args:
        message: The message that was sent.
    """
    if message.author.bot:
        return
    # Handler logic
```

## Database Patterns

### Model Definitions

All database models inherit from `BaseModel`:

```python
from models.database.baseModel import BaseModel
from tortoise import fields

class User(BaseModel):
    """Represents a Discord user in the database."""
    
    id = fields.IntField(pk=True, description="User ID")
    discord_id = fields.BigIntField(
        unique=True,
        description="Discord user ID"
    )
    username = fields.CharField(
        max_length=255,
        description="Discord username"
    )
```

### Database Operations

- Use `await Model.get_or_create()` for idempotent operations
- Always use `await` for database operations
- Fetch related fields explicitly with `await model.fetch_related("relation_name")`
- Prefer model methods for business logic over raw queries

Example:

```python
# Get or create a user
user, created = await User.get_or_create(
    discord_id=ctx.author.id,
    defaults={"username": ctx.author.name}
)

# Fetch related data
await user.fetch_related("quotes")
```

### Migrations

When modifying database models:

1. Create migration: `aerich migrate --name=descriptive_name`
2. Apply migration: `aerich upgrade`

## Common Patterns

### Async/Await

- All Discord.py command handlers are `async`
- All Tortoise ORM operations use `await`
- Use `asyncio` for concurrent operations

```python
async def fetch_data() -> dict:
    """Fetch data from multiple sources."""
    # Run multiple async operations concurrently
    results = await asyncio.gather(
        fetch_from_api(),
        fetch_from_database(),
        fetch_from_cache()
    )
    return process_results(results)
```

### Error Handling

Always provide context in error messages:

```python
try:
    result = await risky_operation()
except SpecificException as ex:
    self.logger.error("Failed to perform operation: %s", ex)
    await ctx.respond("User-friendly German error message")
except Exception as ex:
    self.logger.error("Unexpected error: %s", ex)
    await ctx.respond("Ein unerwarteter Fehler ist aufgetreten.")
```

### Logging

Use structured logging with placeholders:

```python
import logging

logger = logging.getLogger('bot')

# Use %s placeholders, not f-strings in log messages
logger.info("User %s executed command %s", user_id, command_name)
logger.error("Error occurred: %s", error)
logger.warning("Warning: %s", warning_message)
```

### Resource Cleanup

- Use tasks with `.start()` for background jobs
- Clean up resources in Cog teardown if needed
- Handle bot shutdown gracefully

```python
from discord.ext import tasks

class MyService(commands.Cog):
    def __init__(self, bot: discord.Bot, logger: logging.Logger) -> None:
        self.bot = bot
        self.logger = logger
        self.background_task.start()
    
    @tasks.loop(hours=24)
    async def background_task(self) -> None:
        """Background task that runs every 24 hours."""
        # Task logic
        pass
    
    def cog_unload(self) -> None:
        """Clean up when the cog is unloaded."""
        self.background_task.cancel()
```

### Environment Variables

- Define in `EXAMPLE.env` (template)
- Load in `.env` (gitignored)
- Access via `os.getenv()` in `utils/constants.py`
- Document all required environment variables

## Language and Communication

- **Code**: All code (variable names, function names, comments) in **English**
- **Documentation**: All documentation files in **English**
- **User-facing messages**: Discord bot commands and responses in **German**
- **Commit messages**: English or German
- **Exception**: README.md is in German (German seminar group project)

## Before Committing

Checklist before committing code:

1. ✅ Code follows YAPF formatting (80 char limit)
2. ✅ Type hints checked with mypy
3. ✅ Bot functionality tested in development environment
4. ✅ Database migrations verified if models changed
5. ✅ Code complexity checked with radon for significant changes
6. ✅ Tests pass (run with `pytest`)
7. ✅ No sensitive data (tokens, credentials) in code
